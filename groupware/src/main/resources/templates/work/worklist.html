<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}">
<body>
	<th:block layout:fragment="Content">
		<div class="container-xxl flex-grow-1">
			<div class="row mt-2 pt-2">
				<h2 class="ms-3">근태 관리</h2>
			</div>
			<div class="card my-4 col-11 p-3">
				<div class="row">
					<div>
						<input type="hidden" th:value="${#authentication.principal.empId}"
							id="id"> <input type="hidden"
							th:value="${#authentication.name}" id="name">
						<button type="button" class="mx-3 mt-3 my-3 btn btn-info"
							data-bs-toggle="modal" data-bs-target="#exampleModal" id="inip"
							style="float: right;">ip등록신청</button>
					</div>
					<div>
						<th:block id="ipcheck">
							<th:block th:if="${emp.wkYn} != '2A2a'">
								<button type="button" class="mx-1 mt-1 btn rounded-pill btn-info"
									id="wkIn" value="1" style="float: left;">출근</button>
								<button type="button" class="mx-1 mt-1 btn rounded-pill btn-success"
									id="wkStop" style="float: right;">조퇴</button>
								<button type="button"
									class="mx-1 mt-1 btn rounded-pill btn-danger doc-delete" id="wkOut"
									style="float: right;">퇴근</button>
							</th:block>
						</th:block>
						<th:block th:unless="${emp.wkYn} != '2A2a'">
							<h4 class="mt-3 text-center">금일 휴가중</h4>
						</th:block>
					</div>

					<div>
						<table class="my-3 mx-1 table table-bordered border-dark text-center">
							<tr>
								<td class="col-1 text-white" style="background-color: #3F72AF;">사원ID</td>
								<td class="col-1 text-white" style="background-color: #3F72AF;">사원번호</td>
								<td class="col-1 text-white" style="background-color: #3F72AF;">사원명</td>
								<td class="col-1 text-white" style="background-color: #3F72AF;">근속연수</td>
								<td class="col-1 text-white" style="background-color: #3F72AF;">근속월수</td>
								<td class="col-1 text-white" style="background-color: #3F72AF;">근무일수</td>
								<td class="col-1 text-white" style="background-color: #3F72AF;">연차사용</td>
								<td class="col-1 text-white" style="background-color: #3F72AF;">지각</td>
								<td class="col-1 text-white" style="background-color: #3F72AF;">조퇴</td>
							</tr>
							<tr>
								<td>[[${emp.empId}]]</td>
								<td>[[${emp.empNo}]]</td>
								<td>[[${emp.empName}]]</td>
								<td>[[${emp.year}]]</td>
								<td>[[${emp.month}]]</td>
								<td>[[${emp.day}]]</td>
								<td>[[${emp.au}]]</td>
								<td>[[${emp.tdy}]]</td>
								<td>[[${emp.early}]]</td>
							</tr>
						</table>
					</div>

					<div class="mt-5 container-fluid">
						<table style="text-center" id="emp]">
							<tr>
								<td><input type="text" readonly value="날짜검색"></td>
								<td><input id="oneDate" type="Date">~<input
									id="twoDate" type="Date"></td>
							</tr>
							<tr>
								<td><select class="form-select" id="wkYn">
										<option value="" selected>전체</option>
										<option value="근무일">근무일</option>
										<option value="연차">연차</option>
										<option value="오전반차">오전반차</option>
										<option value="오후반차">오후반차</option>
								</select></td>
								<td><select class="form-select" id="wkStat">
										<option value="" selected>전체</option>
										<option value="정상근무">정상근무</option>
										<option value="결근">결근</option>
										<option value="지각">지각</option>
										<option value="조퇴">조퇴</option>
								</select></td>
								<td><select class="form-select" id="wkSite">
										<option value="" selected>전체</option>
										<option value="내근">내근</option>
										<option value="외근">외근</option>
								</select></td>
								<td><button type="submit" class="mx-3 my-2  btn btn-primary"
										id="filter">검색</button></td>
							</tr>
						</table>
					</div>
					<div id="workTable">
						<table class="my-2 table table-bordered text-center" style="margin-left: auto; margin-right: auto;">
							<thead>
								<tr>
									<th class="col-1 text-white" style="background-color: #3F72AF;">날짜</th>
									<th class="col-1 text-white" style="background-color: #3F72AF;">출근시간</th>
									<th class="col-1 text-white" style="background-color: #3F72AF;">퇴근시간</th>
									<th class="col-1 text-white" style="background-color: #3F72AF;">근무지</th>
									<th class="col-1 text-white" style="background-color: #3F72AF;">근무상태</th>
									<th class="col-1 text-white" style="background-color: #3F72AF;">근무여부</th>
								</tr>
							</thead>
							<tbody th:each="info : ${list}" id="infos">
								<tr	th:onclick="|location.href='@{/cust/work/workinfo(dt=${#dates.format(info.dt, 'yyyy-MM-dd')}, empId=${info.empId})}'|">
									<td>[[${#dates.format(info.dt, "yyyy/MM/dd")}]]</td>
									<td>[[${#dates.format(info.wkIn, "HH:mm")}]]</td>
									<td>[[${#dates.format(info.wkOut, "HH:mm")}]]</td>
									<td th:if="${info.wkYn == '근무일'}">[[${info.wkYn}]]</td>
									<td th:if="${info.wkYn == '연차'}" class="table-warning">[[${info.wkYn}]]</td>
									<td th:if="${info.wkYn == '오전반차'}" class="table-success">[[${info.wkYn}]]</td>
									<td th:if="${info.wkYn == '오후반차'}" class="table-success">[[${info.wkYn}]]</td>
									<td th:if="${info.wkStat == '정상근무'}">[[${info.wkStat}]]</td>
									<td th:if="${info.wkStat == '결근'}" class="table-danger">[[${info.wkStat}]]</td>
									<td th:if="${info.wkStat == '지각'}" class="table-info">[[${info.wkStat}]]</td>
									<td th:if="${info.wkStat == '조퇴'}" class="table-secondary">[[${info.wkStat}]]</td>
									<td th:if="${info.wkSite == '내근'}">[[${info.wkSite}]]</td>
									<td th:if="${info.wkSite == '외근'}" class="table-light">[[${info.wkSite}]]</td>
								</tr>
							</tbody>
						</table>
						<br>

						<div class="paging mt-2" style="margin-left: auto; margin-right: auto;">
							<th:block th:if="${filter.totalCnt} != 0">
								<nav aria-label="Page navigation">
									<ul class="pagination justify-content-center">


										<th:block th:if="${filter.prev}">
											<li class="page-item prev disabled"><a
												class="page-link pagebtn"
												th:href="|worklist?empId=${#authentication.principal.empId}&page=${filter.startPage - 1 }|">
													<i class="bx bx-chevron-left"></i>
											</a></li>
										</th:block>
										<th:block
											th:each="num : ${#numbers.sequence(filter.startPage, filter.endPage)}">
											<li class="page-item" th:classappend="${num == filter.page ? 'active' : ' '}">
												<a th:href="|worklist?empId=${#authentication.principal.empId}&page=${num}|"
												th:id="${num}" class="page-link pagebtn">[[${num}]]</a>
											</li>
										</th:block>
										<th:block th:if="${filter.next}">
											<li class="page-item next"><a class="page-link pagebtn"
												th:href="|worklist?empId=${#authentication.principal.empId}&page=${filter.endPage + 1 }|">
													<i class="bx bx-chevron-right"></i>
											</a></li>
										</th:block>
										<th:block th:unless="${filter.totalCnt} != 0">
											<p class="text-center mt-4">현재 등록된 기록이 없습니다.</p>
										</th:block>
									</ul>
								</nav>
							</th:block>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- Modal -->
		<div class="modal fade" id="exampleModal" tabindex="-1"
			aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="exampleModalLabel">IP신청</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">지금 접속한 IP를 등록 신청 하시겠습니까?</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" id="outipinsert" data-bs-dismiss="modal">신청</button>
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">취소</button>
					</div>
				</div>
			</div>
		</div>
		
		<input type="hidden" id="ips">
		<input type="hidden" id="city">

		<script th:inline="javascript">
		
		// CSRF
		let header = $("meta[name='_csrf_header']").attr('content');
	    let token = $("meta[name='_csrf']").attr('content');
	    
	     // 현재(컴퓨터) 날짜, 시간
		let {date,time} = today();
		 
		// 클라이언트 ip 확인
		// HTML의 <script> 요소를 생성한다
		  const se = document.createElement('script');
		  // <script> 요소의 src 속성을 설정한다
		  se.src = 'https://ipinfo.io?callback=callback';
		  // <body> 요소의 하위 끝에 붙인다
		  // 그리고 콜백 함수를 호출한다
		  document.body.appendChild(se);
		  // 앞서 생성한 <script> 요소를 제거한다
		  document.body.removeChild(se);
		
		  // 콜백 함수가 호출된다
		  function callback(data) {
			  $('#ips').attr('value', data.ip);
			  $('#city').attr('value', data.city);
		  }
		
			
		  
		// 기간 검색 범위처리
	    $('#oneDate').on('change', function(e) {
	        $('#twoDate').attr('min', this.value);
	    });
	    $('#twoDate').on('change', function(e) {
	        $('#oneDate').attr('max', this.value);
	    });
	    
		// 검색 조건 변수 생성
			let oneDate;
			let twoDate;
			let wkYn;
			let wkStat;
			let wkSite;
			let empId = $('#id').val();
			let page;
			
		// 필터 클릭 이벤트.
		    $("#filter").on("click", function(e) {
		        filters();
		        let page = 1;
		        filterTable(page);
		    });
		
		 // 페이징 링크 처리
	    $(document).on("click", ".pagebtn", function(e) {
	        e.preventDefault();
	        let page = e.target.id;
	        filterTable(page);
	    });
		
		// 검색 조건 갱신
			function filters() {
			// 날짜 검색
				oneDate = $('#oneDate').val();
				twoDate = $('#twoDate').val();
				
			// 상태 조건 
				wkYn = $('#wkYn').val();
				wkStat = $('#wkStat').val();
				wkSite = $('#wkSite').val();
		}	
				
		function filterTable(page) {
				$.ajax({
					url : '/cust/work/worklistfilter',
					method : 'POST',
					beforeSend: function(xhr) {
		                xhr.setRequestHeader(header, token);
		            },
					data : {
						empId : empId,
						page : page,
						oneDate : oneDate,
						twoDate : twoDate,
						wkYn : wkYn,
						wkStat : wkStat,
						wkSite : wkSite
					},
					dataType: 'Text',
					success :function(result){
						$('#workTable').replaceWith(result);
					}
					});
		        }
			
			// 출근
			 $('#wkIn').on('click', wkins);
			// 퇴근
			$('#wkOut').on('click', wkouts);
			// 조퇴
			$('#wkStop').on('click', wkstops);
				
			
			let rowIps = [[${iplist}]];
			let ipbox = [];
			
			rowIps.forEach(function(item){
				ipbox.push(item.ip);
			})
			
			// 출근
			function wkins() {
				// 출근 등록
				let empId = $('#id').val();
				let times = time;
				let days = date;
				let ip = $('#ips').val();
				let city = $('#city').val();
				
				// ipcheck
				let client = $('#ips').val();
				let ipcheck = false;
				
				for(let i = 0; i< ipbox.length; i++) {
						if(ipbox[i] == client){
							ipcheck = true;
						}
					}
				
				if (ipcheck == true) {
				$.ajax({
					url : '/cust/work/workin',
					method :'POST',
					data :{
				           dt: days,
				           empId: empId,
				           wkInLoc: city
					},
					beforeSend: function(xhr) {
		                xhr.setRequestHeader(header, token);
		            },
				    success : function(result){
				    	if(result == -1){
				    	Swal.fire({
					    	title: '오늘은 이미 출근하셨습니다', 
					    	text: '문의는 관리자에게',
					    	icon: 'error'});
				    	}else{
				    	Swal.fire({
				    		title: '출근하셨습니다', 
				    		text: '화이팅!!',
				    		icon: 'success'
				    		}).then(function() {
				    			location.reload(true);
				    		});
				    	
				    	}
				    }
				})
				
				} else {
				Swal.fire({
			    	title: '회사 IP가 아닙니다.', 
			    	text: '관리자에게 문의해주세요.',
			    	icon: 'error'});
			}
			};
			// 퇴근
			function wkouts() {
				let empId = $('#id').val();
				let times = time;
				let days = date;
				let ip = $('#ips').val();
				let city = $('#city').val();
				
				// ipcheck
				let client = $('#ips').val();
				let ipcheck = false;
				
				for(let i = 0; i< ipbox.length; i++) {
						if(ipbox[i] == client){
							ipcheck = true;
						}
					}
				
				if (ipcheck == true) {
					
				$.ajax({
					url : '/cust/work/workout',
					method :'POST',
					data :{
				           dt: days,
				           empId: empId,
				           wkOutLoc: city
					},
					beforeSend: function(xhr) {
		                xhr.setRequestHeader(header, token);
		            },
				    success : function(result){
				    	Swal.fire({
				    		title: '퇴근하셨습니다', 
				    		text: '수고많으셨습니다.',
				    		icon: 'success'
				    	}).then(function() {
				    	location.reload(true);
				    	});
				    }
				})
				}else {
					Swal.fire({
				    	title: '회사 IP가 아닙니다.', 
				    	text: '관리자에게 문의해주세요.',
				    	icon: 'error'});
				}
			};
			// 조퇴
			function wkstops() {
				let empId = $('#id').val();
				let times = time;
				let days = date;
				let ip = $('#ips').val();
				let city = $('#city').val();
				
				// ipcheck
				let client = $('#ips').val();
				let ipcheck = false;
				
				for(let i = 0; i< ipbox.length; i++) {
						if(ipbox[i] == client){
							ipcheck = true;
						}
					}
				
				if (ipcheck == true) {
				
				$.ajax({
					url : 'workstop',
					method :'POST',
					data :{
				           dt: days,
				           empId: empId,
				           wkOutLoc: city
					},
					beforeSend: function(xhr) {
		                xhr.setRequestHeader(header, token);
		            },
				    success : function(result){
				    	Swal.fire({
				    		title: '조퇴하셨습니다!!', 
				    		text: '',
				    		icon: 'success'
				    		}).then(function() {
				    			location.reload(true);
				    	})
				    }
				})
				}else {
					Swal.fire({
				    	title: '회사 IP가 아닙니다.', 
				    	text: '관리자에게 문의해주세요.',
				    	icon: 'error'});
				}
			};
		$("#outipinsert").on("click",function() {
			let empId = $('#id').val();
			let ip = $('#ips').val();
			
			$.ajax({
				url : "workoutip",
				method :"POST",
				data :{
			           empId: empId,
			           ip: ip
				},
				beforeSend: function(xhr) {
	                xhr.setRequestHeader(header, token);
	            },
			    success : function(result){
			    	Swal.fire({
			    		title: "등록에 성공했습니다.", 
			    		text: '',
			    		icon: 'success'});
			    },
			    error : function(){
			    	Swal.fire({
			    		title: "이미 등록된 ip입니다.", 
			    		text: '',
			    		icon: "error"});
			    }
			})
		});
		
		</script>
	</th:block>
</body>
</html>