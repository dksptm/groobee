<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default_layout}">
<body>

	<th:block layout:fragment="Content">
		<div class="container-xxl flex-grow-1">
			<div class="flex-xl-nowrap row">
				<div class="row">
					<div class="row mt-3 pt-3">
						<h2 class="ms-3">템플릿 등록</h2>
					</div>
					<div class="card my-2">
						<div class="card-body">
							<!-- 템플릿 등록/수정 -->
							<form id="tempInsertForm" th:action="@{/tempInsert}"
								method="post" th:object="${tempVO}"
								enctype="multipart/form-data">
								<div class="card-body">
									<div class="mt-1 row">
										<label for="title"
											class="col-md-2 col-form-label text-white text-center fs-6"
											style="background-color: #3F72AF;">템플릿번호</label>
										<div class="col-md-5">
											<input class="form-control" type="text" placeholder="자동 등록"
												value="자동 등록" disabled />
										</div>
									</div>
									<div class="mt-1 row">
										<label for="title"
											class="col-md-2 col-form-label text-white text-center fs-6"
											style="background-color: #3F72AF;">사용고객사</label>
										<div class="col-md-3">
											<input class="form-control custRealName"
												type="text" readOnly />
											<input class="form-control custName" th:field="*{custNo}"
												type="hidden" readOnly />
										</div>

										<!-- 고객사 선택 모달버튼 -->
										<div class="col-md-3">
											<button type="button" class="btn btn-primary"
												data-bs-toggle="modal" data-bs-target="#CustModal">고객사
												선택</button>
										</div>

										<!-- 고객사 선택 모달화면 -->
										<div class="modal fade" id="CustModal" tabindex="-1">
											<div
												class="modal-dialog modal-xl modal-dialog-scrollable w-25 h-75"
												role="document">
												<div class="modal-content">
													<div class="modal-header">
														<h5 class="modal-title" id="modalScrollableTitle">고객사
															선택</h5>
														<button type="button" class="btn-close"
															data-bs-dismiss="modal" aria-label="Close"></button>
													</div>
													<div class="modal-body">
														<table class="table table-hover text-center">
															<thead>
																<tr style="background-color: #3F72AF;">
																	<th class="text-white">상호명</th>
																	<th class="text-white">고객번호</th>
																	<th class="text-white">대표자명</th>
																	<th class="text-white">선택</th>
																</tr>
															</thead>
															<tbody>
																<th:block th:each="CustVO : ${custlist}">
																	<tr class="custTr">
																		<td>[[ ${CustVO.custName} ]]</td>
																		<td>[[ ${CustVO.custNo} ]]</td>
																		<td>[[ ${CustVO.rep} ]]</td>
																		<td><input type="radio" name="check" th:class="${CustVO.custName}"
																			th:value="${CustVO.custNo}"></td>
																	</tr>
																</th:block>
															</tbody>
														</table>
													</div>
													<div class="modal-footer">
														<button type="button" class="btn btn-primary selectCust"
															data-bs-dismiss="modal">선택완료</button>
														<button type="button" class="btn btn-secondary"
															data-bs-dismiss="modal">닫기</button>
													</div>
												</div>
											</div>
										</div>
									</div>
									<div class="mt-1 row">
										<label for="title"
											class="col-md-2 col-form-label text-white text-center fs-6"
											style="background-color: #3F72AF;">템플릿명</label>
										<div class="col-md-5">
											<input class="form-control tempname" th:field="*{tempName}"
												type="text" />
										</div>
									</div>
									<div class="mt-1 row">
										<label for="cntn"
											class="col-md-2 col-form-label text-white text-center fs-6"
											style="background-color: #3F72AF;">설명</label>
										<div class="col-md-5">
											<textarea class="form-control tempinfo"
												th:field="*{tempInfo}"></textarea>
										</div>
									</div>
									<div class="mt-2 col-2">
										<label for="tempId" class="form-label">등록방식</label> <select
											class="form-select inserttype">
											<option value="option">-선택-</option>
											<option value="input">직접입력</option>
											<option value="upload">업로드</option>
										</select>
									</div>
								</div>
							</form>

							<!--  작성완료 버튼 -->
							<div class="d-flex justify-content-end px-3 mt-2">
								<div class="text-end px-2">
									<button type="button" class="btn btn-info commitbtn">등록완료</button>
								</div>
								<div class="text-end">
									<button type="button"
										th:onclick="|location.href='@{/sol/tempList}'|"
										class="btn btn-secondary">등록취소</button>
								</div>
							</div>
							<div class="mt-3 col-12 tempdiv"></div>

						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- <script src="/js/html2canvas.js"></script> -->
		<script src="http://html2canvas.hertzen.com/dist/html2canvas.js"></script>
		<script src="https://rawgit.com/jackmoore/autosize/master/dist/autosize.min.js"></script>
		<script>
			//CSRF
			let header = $("meta[name='_csrf_header']").attr('content');
			let token = $("meta[name='_csrf']").attr('content');
			
			//고객사 모달처리
			//모달창에서 선택한 고객사번호를 input창에 입력.
			$(".selectCust").on("click", function(e){
				$(".custName").val($('input:radio:checked').val());
				$(".custRealName").val($('input:radio:checked').attr('class'));
			});
			
			//고객사 행 클릭시 라디오버튼 선택
			$(document).on('click', '.custTr', function(){
				let radio = $(this).find('td :radio');
				radio.attr('checked', !radio.is(':checked'));
			});
			/* $('#custTr').on('click', function(){
				let radio = $(this).find('td :radio');
				radio.attr('checked', !radio.is(':checked'));
			}); */
					
			//업로드or직접입력 선택
			//직접입력 Tag
			let templateA = `
				<div class="mt-3">템플릿HTML명</div>
				<div class="col-md-5">
					<input class="form-control inputTemp" id="filename" type="text" />
				</div>
				<div class="mt-3">템플릿HTML입력</div>
				<textarea class="form-control inputTemp w-100 p-1" id="content"></textarea>
				<!-- 템플릿 초기화 버튼 -->
				<div class="d-flex justify-content-end mb-3">
					<button type="button" class="btn btn-primary mt-2 mx-2" id="htmlreset">초기화</button>
				</div>
				<h4 class="tempPre">=템플릿 미리보기=</h4>
				<div style="width: 210mm; height: 297mm; position: relative;"
					class="tempPre template p-3 border border-dark"></div>
			`;
			//업로드 Tag
			let templateB = `
				<div class="test">
					<input name="uploadFiles2" id="uploadFiles2" onchange="previewFile()" type="file" accept=".html">
				</div>
				<div style="background-color: #ffffff; display: inline-block; position: relative; "
					class="upload-sample p-3" ></div>
			`;
			
			//업로드,직접입력 템플릿 반영
			$(".inserttype").on("change", function(e) {
				if ($(".inserttype").val() == "input") {
					$(".tempdiv").html(templateA);
				} else if($(".inserttype").val() == "upload"){
					$(".tempdiv").html(templateB);
				} else{
					$(".tempdiv").html('');
				}
			});

			//직접입력값 미리보기
			let tVal;
			let fileName;
			$(".tempdiv").on("keyup", ".inputTemp", function(e) {
				$(".template").css('display', 'block');
				tVal = $("#content").val()
				fileName = $("#filename").val();
				$(".template").html(tVal);
				autosize($("#content"));
			});
			

			//직접입력값 초기화
			$(".tempdiv").on("click", "#htmlreset", function(e) {
				console.log($(".inputTemp").val());
				$(".inputTemp").val("");
				$(".template").empty();
			});
				
			//템플릿 등록 버튼
			$(".commitbtn").on("click", async function(e) {
			    e.preventDefault();
			    //유효성검사
				let inputs = $('input');
				let veilcheck = true;
				
			    $('input').each(function() {
			    	
			        if ($(this).attr('type') === 'checkbox' || $(this).attr('type') === 'radio') {
			            if ($(this).attr('name') && $('input[name="' + $(this).attr('name') + '"]:checked').length === 0) {
			            	veilcheck = false;
			                return false;
			            }
			        } else if ($('.inserttype').val() === 'option'){
			        	veilcheck = false;
			            return false;
			        } else if ($('#content').val() === '' || $('#filename').val() === '' || $('#uploadFiles2').val() === ''){
			        	veilcheck = false;
			            return false;
			        } else if ($(this).val().trim() === '' && !$(this).closest('.tempdiv').length) {
			        	veilcheck = false;
			            return false;
			        }
			    });
			    
			    Swal.fire({
					  title: '템플릿을 등록하시겠습니까?',
					  text: "",
					  icon: 'warning',
					  showCancelButton: true,
					  confirmButtonColor: '#3085d6',
					  cancelButtonColor: '#d33',
					  confirmButtonText: '등록',
					  cancelButtonText: '취소'
					}).then(async (result) => {
					  if (result.value) {
								
					    if (!veilcheck) {
					    	Swal.fire({
								icon: 'error',               
							  	title: '모든 항목을 입력해주세요.',    
							  	text: '', 
							});
					        return;
					    };
			    
		    try {
				//템플릿 속성값 추가
			    let tempName = $('.tempname').val();
			    let tempInfo = $('.tempinfo').val();
			    let custNo = $('.custName').val();
		    	let formData;
				let fileInput;
			    let fileList;
			    let path;
		        let saveName;
		        let uplName;
			    
						 if ($(".inserttype").val() == "upload") { //업로드 선택시 파일처리
							formData = new FormData();
						    fileInput = document.querySelector('input[name="uploadFiles2"]');
						    fileList = fileInput.files;
						    for(let file of fileList){
						        formData.append('uploadFiles', file);
						    }
						  //파일 업로드 처리
					    	let result = await $.ajax({
							            url: '/uploadsAjax',
							            beforeSend: function(xhr){
							                xhr.setRequestHeader(header, token);
							            },
							            type: 'POST',
							            processData: false,    
							            contentType: false,    
							            data: formData
					        });
				    		
					        for(let filePath of result){
					            path = filePath.split(":::");
					        }
					        saveName = path[3];
					        uplName = saveName.split("/").pop();
						} else if($(".inserttype").val() == "input"){ //직접입력 선택시 HTML생성처리
							let result = await $.ajax({
										url: '/uploadsHtml',
										beforeSend: function(xhr){
									        xhr.setRequestHeader(header, token);
									    },
							            type: 'POST',
							            data: JSON.stringify({tags:tVal,fileName:fileName}),
							            dataType: 'text',
							            contentType: 'application/json;charset=UTF-8'
							});
					        path = result.split(":::");
					        saveName = path[3];
					        uplName = saveName.split("/").pop();
						};
				    	
				        // 파일 미리보기 이미지 생성
				         /* let html = await $.ajax({
				            url: 'files/' + path[3],
				            dataType: "html"
				        });
				        $('.upload-sample').css('display', 'block');
				        $('div.upload-sample').html(html);  */
				
				        var t;
				        if ($(".inserttype").val() == "input") {
				        	t = $('div.template')[0];
						} else if($(".inserttype").val() == "upload"){
							t = $('div.upload-sample')[0];
						}
				        var canvas = await html2canvas(t);
				        var myImg = canvas.toDataURL("image/png").replace("data:image/png;base64,", "");
				
				        // 템플릿 등록
				        await $.ajax({
				            url : '/sol/insertSolTemp',
				            beforeSend: function(xhr){
				                xhr.setRequestHeader(header, token);
				            },
				            type : 'POST',
				            data : {
				                'imgSrc' : myImg,
				                'tempName' : tempName,
				                'tempInfo' : tempInfo,
				                'custNo' : custNo,
				                'saveName' : saveName,
				                'uplName' : uplName
				            },
				            dataType : 'text'
				        });
				
				        Swal.fire({
							icon: 'success',               
						  	title: '등록 완료.',    
						  	text: '', 
						}).then((result) => {
					        location.replace("/sol/tempList");
						});
						
			    } catch (error) {
			    	Swal.fire({
						icon: 'error',               
					  	title: '등록 오류 발생.',    
					  	text: '', 
					});
			        //console.log("작업 중 오류 발생:", error);
			    }
			  }
			});
		});

		//HTML미리보기 처리 함수
		function previewFile() {
            //const content = document.querySelector(".upload-sample");
            const content = $(".upload-sample");
            const [file] = document.querySelector("input[type=file]").files;
            const reader = new FileReader();

            reader.addEventListener("load", () => {
                    const parser = new DOMParser();
                    const doc3 = parser.parseFromString(reader.result, "text/html");
                    //content.append(doc3.body);
                    content.html('');
                    $(doc3.body).children().appendTo('.upload-sample');
                },
                false,
            );
            if (file) {
                reader.readAsText(file);
            } 
        }
		</script>
	</th:block>
</body>
</html>